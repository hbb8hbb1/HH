# 连接后端数据库指南

## 📋 当前配置

- **后端端口**：5001（vite.config.ts 中配置的代理目标）
- **MongoDB URI**：`mongodb://localhost:27017/offermagnet`（默认，可在 `.env` 中配置）
- **前端代理**：`/api` → `http://localhost:5001`

## 🚀 连接步骤

### 步骤 1：检查 MongoDB 是否运行

**选项 A：使用本地 MongoDB**

```bash
# 检查 MongoDB 是否运行
brew services list | grep mongodb
# 或者
ps aux | grep mongod

# 如果未运行，启动 MongoDB
brew services start mongodb-community
# 或者
mongod --config /usr/local/etc/mongod.conf
```

**选项 B：使用 MongoDB Atlas（云数据库）**

1. 访问 [MongoDB Atlas](https://www.mongodb.com/cloud/atlas)
2. 创建集群并获取连接字符串
3. 在 `server/.env` 文件中配置：

```bash
MONGO_URI=mongodb+srv://username:password@cluster.mongodb.net/offermagnet?retryWrites=true&w=majority
```

### 步骤 2：配置环境变量（可选）

如果需要自定义 MongoDB 连接，编辑 `server/.env` 文件：

```bash
cd /Users/henghuang/Desktop/代码/HH-main/server
# 如果 .env 文件不存在，复制 .env.example
cp .env.example .env

# 编辑 .env 文件，设置 MongoDB URI
# MONGO_URI=mongodb://localhost:27017/offermagnet
# 或者使用 MongoDB Atlas
# MONGO_URI=mongodb+srv://username:password@cluster.mongodb.net/offermagnet
```

### 步骤 3：启动后端服务器

```bash
cd /Users/henghuang/Desktop/代码/HH-main/server

# 方式 1：使用启动脚本
../../启动后端.sh

# 方式 2：直接运行
PORT=5001 node index.js

# 方式 3：使用 npm（如果有 scripts）
npm start
```

**预期输出：**
```
MongoDB connected
Server running on port 5001
```

### 步骤 4：验证连接

**测试后端 API：**

```bash
# 测试获取帖子列表
curl http://localhost:5001/api/posts?page=1&limit=20

# 应该返回 JSON 格式的数据
```

**检查数据库连接：**

```bash
# 如果使用本地 MongoDB，可以连接查看
mongosh mongodb://localhost:27017/offermagnet

# 查看集合
show collections

# 查看帖子数量
db.posts.countDocuments()
```

### 步骤 5：确保前端正在运行

前端应该已经运行在 `http://localhost:3000`，如果未运行：

```bash
cd /Users/henghuang/Desktop/代码/HH-main
npm run dev
```

## 🔍 故障排查

### 问题 1：MongoDB 连接失败

**错误信息：** `MongoServerError: connect ECONNREFUSED`

**解决方案：**
1. 检查 MongoDB 是否运行：`ps aux | grep mongod`
2. 检查端口是否被占用：`lsof -i :27017`
3. 如果使用 MongoDB Atlas，检查：
   - 网络访问白名单（IP 地址）
   - 连接字符串是否正确
   - 用户名和密码是否正确

### 问题 2：后端服务器启动失败

**检查：**
```bash
# 检查端口 5001 是否被占用
lsof -i :5001

# 如果被占用，结束进程或修改端口
kill -9 <PID>
```

### 问题 3：前端无法获取数据

**检查：**
1. 后端是否正常运行：`curl http://localhost:5001/api/posts`
2. 前端代理配置是否正确（vite.config.ts）
3. 浏览器控制台是否有错误

### 问题 4：数据库为空

如果数据库中没有数据，需要导入数据：

```bash
cd /Users/henghuang/Desktop/代码/hh_pipeline
python3 import_posts_via_api.py \
  --api-base http://127.0.0.1:5001 \
  --email "your@email.com" \
  --password "yourpassword" \
  --data-dir ./data_final
```

## ✅ 验证连接成功

1. **后端日志显示：** `MongoDB connected`
2. **API 测试返回数据：** `curl http://localhost:5001/api/posts` 返回 JSON
3. **前端页面显示真实数据：** 刷新 `http://localhost:3000`，应该看到数据库中的帖子

## 📝 快速检查清单

- [ ] MongoDB 正在运行（本地或 Atlas）
- [ ] `server/.env` 文件配置正确（如果需要）
- [ ] 后端服务器运行在端口 5001
- [ ] 前端开发服务器运行在端口 3000
- [ ] 可以访问 `http://localhost:5001/api/posts`
- [ ] 前端页面显示数据库中的数据（而不是 MOCK 数据）

## 🎯 当前状态

根据检查：
- ✅ 前端已运行在 `http://localhost:3000`
- ❌ 后端服务器未运行（需要启动）
- ❓ MongoDB 状态未知（需要检查）

**下一步：** 启动后端服务器，然后刷新前端页面查看真实数据。

